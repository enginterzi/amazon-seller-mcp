#!/bin/sh
#
# Pre-commit hook for comprehensive quality validation
# Enforces zero lint errors, successful build, and passing tests
#

echo "ğŸ” Running pre-commit quality validation..."

# Track overall success
OVERALL_SUCCESS=1

# Function to run a check and report results
run_check() {
    local check_name="$1"
    local command="$2"
    local required="$3"
    
    echo "  â†’ $check_name..."
    
    if eval "$command" > /dev/null 2>&1; then
        echo "    âœ… $check_name passed"
        return 0
    else
        echo "    âŒ $check_name failed"
        if [ "$required" = "true" ]; then
            OVERALL_SUCCESS=0
        fi
        return 1
    fi
}

# 1. Lint validation (MANDATORY - zero errors required)
echo "ğŸ”§ Validating code quality..."
if ! run_check "ESLint validation" "npm run lint" "true"; then
    echo "    ğŸ’¡ Fix lint errors with: npm run lint -- --fix"
    echo "    ğŸ’¡ Or format code with: npm run format"
fi

# 2. TypeScript compilation (MANDATORY - build must succeed)
echo "ğŸ—ï¸  Validating TypeScript compilation..."
if ! run_check "TypeScript build" "npm run build" "true"; then
    echo "    ğŸ’¡ Fix TypeScript errors before committing"
fi

# 3. Test execution (MANDATORY - all tests must pass)
echo "ğŸ§ª Validating test suite..."
if ! run_check "Test execution" "npm test" "true"; then
    echo "    ğŸ’¡ Fix failing tests before committing"
    echo "    ğŸ’¡ Run tests with: npm test"
fi

# 4. Code formatting check
echo "ğŸ¨ Validating code formatting..."
if ! run_check "Prettier formatting" "npm run format -- --check" "false"; then
    echo "    ğŸ’¡ Auto-format code with: npm run format"
    # Auto-format if possible
    echo "    ğŸ”§ Auto-formatting code..."
    if npm run format > /dev/null 2>&1; then
        echo "    âœ… Code formatted automatically"
    fi
fi

# 5. Test health check (WARNING - not blocking)
echo "ğŸ¥ Running test health check..."
if ! run_check "Test health validation" "npm run test:quick-check" "false"; then
    echo "    âš ï¸  Test health issues detected (non-blocking)"
    echo "    ğŸ’¡ Run 'npm run test:maintenance health-check' for details"
fi

# Final validation
if [ $OVERALL_SUCCESS -eq 0 ]; then
    echo ""
    echo "âŒ Pre-commit validation failed!"
    echo ""
    echo "The following quality gates must pass before committing:"
    echo "  â€¢ Zero lint errors (npm run lint)"
    echo "  â€¢ Successful TypeScript build (npm run build)"
    echo "  â€¢ All tests passing (npm test)"
    echo ""
    echo "ğŸ’¡ To skip these checks (not recommended): git commit --no-verify"
    echo ""
    exit 1
fi

echo ""
echo "âœ… All quality gates passed! Proceeding with commit..."
echo ""